<!DOCTYPE html>
<!--
Copyright 2011 Google Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

   http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.

Author: Eric Bidelman (ericbidelman@chromium.org)
-->
<html>
<head>
  <title>Scala Study Part1</title>
  <meta charset="utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <script src='slides.js'></script>
  <link href="http://fonts.googleapis.com/css?family=Raleway:100" rel="stylesheet" type="text/css">
  <link href="http://fonts.googleapis.com/css?family=Open+Sans:300" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Open+Sans:regular,semibold,italic,italicsemibold|Droid+Sans+Mono&v2">
</head>
<body style="display: none">

<section class='slides layout-regular'>

  <article class="biglogo">
    <script>
      (function() {
        var c = document.createElement('canvas');
        var ctx = null;
        try {
          ctx = c.getContext('webgl');
        } catch(e) { }
        try {
          ctx = ctx || c.getContext('experimental-webgl');
        } catch(e) { }
        if (!ctx) alert("No WebGL detected, live demos disabled!");
      })();
    </script>
  </article>

  <article id="title" class="title">
    <div>
      <h1>CA Scala Study Part19</h1>
      <h2 class="subtitle">Wataru Fukunaga</h2>
      <h3 class="subtitle"><img style="height:60px; padding-left:70px;" src="images/ca_logo.png"></h3>
    </div>
  </article>

  <article>
    <h3>Who am I?</h3>
    <h4>Wataru Fukunaga</h4>
    <p><a href="http://twitter.com/wataru420">@wataru420</a> 
      | <a href="http://ameblo.jp/wataru420">amebaId:wataru420</a>
    <p>Cyberagent Application Engineer</p>
    <br><br>
    <p>Scalaコップ本輪読会用の資料です。</p>
    <br><br>
    <p>Slides available at <a href="http://goo.gl/SVfmP">http://goo.gl/SVfmP</a></p>
    <p>I use this: <a href="https://github.com/kig/BasicsOfThreeJS">github.com/kig/BasicsOfThreeJS</a></p>
      
  </article>

  <article class="title">
    <h2>コップ本輪読会</h2>
    <h3 class="subtitle">型パラメータ</h3>
  </article>

  <article>
    <h3>Agenda</h3>
    <ul style="font-size:120%">
      <li>関数型待ち行列</li>
      <li>変位指定アノテーション</li>
	  <li><Del>コンパイラー</Del></li>
    </ul>
    <br><br>
    <ul class="build">
	<p style="font-size:200%">コップが溢れる程</p>
	<p style="font-size:200%">　　　　　Scalaを愛したい</p>
    </ul>

  </article>


  <article>
    <h3>関数型待ち行列</h3>
    <ul style="font-size:120%">
		<li>head: <br/>待ち行列の先頭</li>
      <li>tail: <br/>先頭要素以外の要素で構成された待ち行列</li>
      <li>append: <br/>指定した要素を末尾に追加した新しい待ち行列</li>
    </ul>
    <br><br>
    <ul class="build">
	<p style="font-size:100%">リスト構造に似ているが、リストでの連結操作::が先頭に要素を結合するのに対して関数型待ち行列はappendで末尾に結合する部分が異なる</p>
    </ul>

  </article>

  <article>
    <h3>Listを使った実装</h3>
	<p><a href="https://gist.github.com/3695744" target="blank">https://gist.github.com/3695744</a></p>
    <ul class="build">
	<p style="font-size:100%">しかしこのappend、要素数の増加に比例して実行時間が伸びていきます。</p>
    </ul>
  </article>

  <article>
    <h3>elemを逆向きで管理すればappendは早くなる?</h3>

    <pre>
	// elems の要素を逆順したものをsmeleを利用します<br/>
	val smele = elems.reverse</pre>
	<p><a href="https://gist.github.com/3695744" target="blank">https://gist.github.com/3695904</a></p>
    <ul class="build">
	<p style="font-size:100%">appendは早くなるが、それ以外が要素数分の処理時間が必要になる。</p>
    </ul>
  </article>

  <article>
    <h3>2つを組み合わせてみた</h3>
	<p><a href="https://gist.github.com/3695939" target="blank">https://gist.github.com/3695939</a></p>
    <ul class="build">
		<p style="font-size:100%">一応処理的には問題ない<br/>
		けどパラメータがめっちゃわかりにくい。</p>
    </ul>
  </article>

  <article class="title">
    <h2>もっと型っぽく</h2>
  </article>

  <article>
    <h3>コンストラクターの隠蔽</h3>
    <pre>
// private修飾子で基本コンストラクタを隠蔽します
class Queue[T] private (
  private val leading:List[T],
  private val trailing:List[T]
){}

// 連続パラメータを初期要素とする補助コンストラクタ
def this(elems:T*) = this(elems.toList, Nil)</pre>
	<p><a href="https://gist.github.com/3696004" target="blank">https://gist.github.com/3696004</a></p>
    <ul class="build">
		<p style="font-size:100%">こんなかんじで呼べるようになる<br/>
		scala&gt; new Queue(1,2,3,4,5)</p>
    </ul>
  </article>

  <article>
    <h3>コンパニオンオブジェクト</h3>
    <pre>
// コンパニオンオブジェクトを定義
object Queue {
  // 初期要素xsを利用して待ち行列を構築しますね
  def apply[T](xs:T*) = new Queue[T](xs.toList, Nil)
}</pre>
	<p><a href="https://gist.github.com/3696020" target="blank">https://gist.github.com/3696020</a></p>
	<p>applyメソッドを呼び出す際は、メソッド名（とその前に付けるピリオド）を省略することが出来るというルールがあるので</p>
    <ul class="build">
		<p style="font-size:100%">こんなかんじで呼べるようになる<br/>
		scala&gt; Queue(1,2,3,4,5)</p>
    </ul>
  </article>

  <article>
    <h3>非公開クラスにする方法</h3>
	<p>公開インターフェイスをtraitに書き、実体は非公開内部クラスで隠す方法。</p>
	<p><a href="https://gist.github.com/3696033" target="blank">https://gist.github.com/3696033</a></p>
    <ul class="build">
		<p style="font-size:100%">だいぶ過激<br/>
		でもだいぶ型っぽくなってきた</p>
    </ul>
  </article>

  <article>
    <h3>Queueは型？</h3>
    <pre>
scala&gt; def doesNotCompile(q: Queue) {}</pre>
	<p>これはコンパイル通らない</p>
    <ul class="build">
    <pre>
scala&gt; def doesNotCompile(q: Queue[AnyRef]) {}</pre>
		<p style="font-size:100%">これは通る</p>
		<p style="font-size:100%">Queueはトレイト<br/>Queue[String]は型<br/><br/>型コンストラクターとかジェネリックトレイトと呼ぶ</p>
    </ul>
  </article>

  <article class="title">
    <h2 style="font-size:130%">変位指定アノテーション</h2>
  </article>

  <article>
  <h3>種類</h3>
  <p>非変</p>
  <pre>
Queue[T]</pre>
  <p>共変</p>
  <pre>
Queue[+T]</pre>
  <p>反変</p>
  <pre>
Queue[-T]</pre>
    <ul class="build">
	<p>反変って何につかうんだろう。。</p>
    </ul>
  </article>

  <article>
    <h3>非変</h3>
	<pre>
// 非変な独自型
class Cell[T](init:T){
  private[this] var current = init
  def get = current
  def set(x:T){current = x}
}</pre>
	<p>試してみると</p>
    <ul class="build">
	<pre>
scala> val c1 = new Cell[String]("abc")
scala> val c2:Cell[Any] = c1
<console>:6: error: type mismatch;</pre>
    </ul>
  </article>

  <article>
    <h3>共変</h3>
	<pre>
// 共変な独自型
class Cell[+T](init:T){
  private[this] var current = init
  def get = current
  def set(x:T){current = x}
}</pre>
	<p>試してみると</p>
    <ul class="build">
	<p>これはコンパイル通らない</p>
	<p>setメソッドでサブ型の関係性が保持できないかも</p>
    </ul>
  </article>

  <article>
    <h3>破綻するケース</h3>
	<pre>
val c1 = new Cell[String]("abc")
val c2:Cell[Any] = c1
c1.set(1)
val s:String = c1.get</pre>
	<p>Javaでやると</p>
	<pre>
String[] a1 = {"abc"};
Object[] a2 = a1;
a2[0] = new Integer(17)
String a = a1[0]</pre>
    <ul class="build">
	<p>コンパイル通るがArrayStoreException例外が投げられる</p>
    </ul>
  </article>

  <article>
    <h3>JavaのをScalaで</h3>
	<pre>
val a1 = Array("abc")
val a2:Array[Any] = a1</pre>
	<p>Scalaの配列は非変（厳格）だから怒られる</p>
    <ul class="build">
	<p>でも、抜け道があります！</p>
    <pre>
val a1 = Array("abc")
val a2:Array[Object] = a1.asInstanceOf[Array[Object]]</pre>
	<p>ただ、ArrayStoreException例外が投げられる可能性は残るけどね</p>
    </ul>
  </article>

  <article>
    <h3 style="font-size:80%">変位指定アノテーションが問題を起こす場合</h3>
	<pre>
class Queue[+T] {
  def append(x:T) = {}
}
class StrangeIntQueue extends Queue[Int] {
  override def append(x:Int) = {
    println(Math.sqrt(x))
    super.append(x)
  }
}</pre>
	<p style="font-size:80%">サブクラスでこんな風に定義すると</p>
    <ul class="build">
    <pre>
val x:Queue[Any] = new StrangeIntQueue
x.append("abc")</pre>
	<p style="font-size:80%">Int -> Any Any -> String = Int -> Stringとなって崩壊</p>
	<p style="font-size:80%">実際はQueueを共変で定義するとコンパイル通らない</p>
    </ul>
  </article>

  <article class="title">
    <h2>もっと知りたい人へ</h2>
  </article>

  <article>
  <h3>変位指定アノテーションのチェックメカニズム</h3>
    <ul class="build">
    <p>P360ページ以降を読むといいかも！</p>
    </ul>
  </article>
  <article class="title">
  <h2 style="font-size:200%">まとめ</h2>
  </article>
  
  <article>
    <h4>難しいけど面白い</h4>
    <h4>魔法使い目指してがんばろう！</h4>
    <a href="http://subtech.g.hatena.ne.jp/secondlife/20090701/1246418689" target="blank">
    <img style="padding-left:50%;" src="http://cdn-ak.f.st-hatena.com/images/fotolife/k/kumajet/20090701/20090701122032.jpg"></a>
  </article>

  <article>
    <h3>The End</h3>
    <p>Wataru Fukunaga</p>
    <p><a href="http://twitter.com/wataru420">@wataru420</a> 
      | <a href="http://ameblo.jp/wataru420">amebaId:wataru420</a>
    <br><br>
    <p>Slides available at <a href="http://goo.gl/SVfmP">http://goo.gl/SVfmP</a></p>
 
  </article>

</section>
<script type="text/javascript">

	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-27158263-1']);
	_gaq.push(['_trackPageview']);

	(function() {
	 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
	 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
	 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	 })();

</script>
<!--[if IE]>
<script src="http://ajax.googleapis.com/ajax/libs/chrome-frame/1/CFInstall.min.js"></script>
<script>CFInstall.check({mode: 'overlay'});</script>
<![endif]-->

</body>
</html>
